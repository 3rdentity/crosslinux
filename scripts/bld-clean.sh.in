#!@@CL_BASH@@


# This file is part of the crosslinux software.
# The license which this software falls under is GPLv2 as follows:
#
# Copyright (C) 2013-2013 Douglas Jerome <douglas@crosslinux.org>
#
# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the Free
# Software Foundation; either version 2 of the License, or (at your option)
# any later version.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
# FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for
# more details.
#
# You should have received a copy of the GNU General Public License along with
# this program; if not, write to the Free Software Foundation, Inc., 59 Temple
# Place, Suite 330, Boston, MA  02111-1307  USA


# *****************************************************************************
#
# PROGRAM DESCRIPTION
#
#      This script builds the crosslinux target packages.
#
# CHANGE LOG
#
#      2013-06-22  drj  Adapted to crosslinux from the ttylinux build system.
#
# *****************************************************************************


# *************************************************************************** #
#                                                                             #
# F I L T E R E D   C O N S T A N T S                                         #
#                                                                             #
# *************************************************************************** #

cl_libdir="@@CL_LIBDIR@@"


# *************************************************************************** #
#                                                                             #
# M A I N   P R O G R A M                                                     #
#                                                                             #
# *************************************************************************** #


# *****************************************************************************
# Set up the shell functions and environment variables.
# *****************************************************************************

source ./crosslinux-config.sh # target build configuration
source ${cl_libdir}/scripts/_constants.sh # build support
source ${cl_libdir}/scripts/_functions.sh # build support

CL_config_setup || exit 1

# Remove the kernel.
#
if [[ $# -gt 0 ]]; then
	[[ x"$1" == x"build" || x"$1" == x"kernel" ]] && {
		echo "=> Removing kernel modules package, if any."
		rm --force --recursive "${TARGET_BUILD_DIR}/kpkgs/"*
		echo "=> Removing kernel and module tree, if any."
		rm --force --recursive "${TARGET_BUILD_DIR}/kroot/"*
		echo "=> Removing kernel source tree, if any."
		rm --force --recursive "${TARGET_BUILD_DIR}/linux-"*
		echo "=> Removing kernel build log, if any."
		for _file in ${TARGET_VAR_DIR}/log/*; do
			if [[ ${_file##*/} =~ ^linux- ]]; then
				rm --force ${_file}
			fi
		done
		unset _file
	} || true
fi

# Remove the packages.
#
if [[ $# -gt 0 ]]; then
	[[ x"$1" == x"build" || x"$1" == x"packages" ]] && {
		echo "=> Removing the packages:"
		echo "   -> Removing build/packages contents."
		rm --force --recursive ${TARGET_BUILD_DIR}/packages/*
		echo "   -> Removing sysroot contents."
		rm --force --recursive ${TARGET_SYSROOT_DIR}/*
		echo "   -> Removing pkg-bin/ binary packages."
		rm --force --recursive ${TARGET_PKGBIN_DIR}/*
		echo "   -> Removing var/log/ build logs."
		for _file in ${TARGET_VAR_DIR}/log/*; do
			if [[ ${_file##*/} =~ ^linux- ]]; then
				:
			else
				rm --force ${_file}
			fi
		done
		echo "   -> Removing var/run/done.* build flags."
		rm --force --recursive ${TARGET_VAR_DIR}/run/done.*
		unset _file
	} || true
fi


# *****************************************************************************
# Exit with Status
# *****************************************************************************

exit 0


# end of file
